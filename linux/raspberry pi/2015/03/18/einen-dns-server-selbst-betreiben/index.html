
<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <title>
      
        Einen DNS Server selbst betreiben - 
      
      0rph3us
    </title>
    <meta name="description" content="">
    <meta name="author" content="Michael Rennecke">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="/assets/themes/hooligan/css/bar.css" rel="stylesheet" type="text/css" media="all" />
<!--    <link href="/assets/themes/hooligan/css/zocial.stripped.css" rel="stylesheet" type="text/css">
    <link href="/assets/themes/hooligan/css/syntax.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/darkstrap.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/lightbox.css" rel="stylesheet" type="text/css" media="all" />
-->
    
<!-- 
    <script type="text/javascript" src="/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="/js/lightbox.min.js"></script>
-->

    <!-- jquery-1.11.1.min.js and lightbox.min.js -->
    <script type="text/javascript" src="/js/a63bb257b0d48f7901f938d2f1217cbb.js"></script>

    <!-- fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->
  </head>

  <body>
    <div id="page-wrap">
      <div class="navbar">
        <div class="navbar-inner">
          <div class="container">
            <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </a>

            <a class="brand" href="/">0rph3us</a>

            <div class="nav-collapse">
              <ul class="nav">
                
                
                


  
    
      
    
  
    
      
      	
      	<li><a href="/about.html">Über mich</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archiv</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Kategorien</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Seiten</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



              </ul>
              <ul class="nav pull-right social visible-desktop">
                <li class="divider-vertical"></li>
                
                <li>
                  <a href="https://github.com/0rph3us" class="zocial github icon" target="_blank">
                    <span class="hidden-desktop">Github</span>
                  </a>
                </li>
                
                
                
                <li>
                  <a href="https://twitter.com/0rph3us" class="zocial twitter icon" target="_blank">
                    <span class="hidden-desktop">Twitter</span>
                  </a>
                </li>
                
                
                
                
                
                <li>
                  <a href="https://0rph3us.github.io/rss.xml" class="zocial rss icon" target="_blank">
                    <span class="hidden-desktop">RSS Feed</span>
                  </a>
                </li>
                
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="content">
          
<div class="page-header">
  <h1>
    Einen DNS Server selbst betreiben 
    
  </h1>
</div>

<div class="row">
  <div class="span8">
    <p>Ich habe mir die Tage einen eigenen <a href="http://de.wikipedia.org/wiki/Domain_Name_System">DNS</a>-Server aufgesetzt. Er macht das Leben einfacher, wenn
man mehrere Dienste im eigenen Netzwerk betreibt. Dazu habe ich <a href="https://www.powerdns.com/">PowerDNS</a> mit einem <a href="http://de.wikipedia.org/wiki/MySQL">MySQL</a>-Backend.
Das ganze lässt sich mit der Weboberfläche <a href="http://www.poweradmin.org/">poweradmin</a> sehr einfach bedienen. Man sollte aber bedenken,
dass jeder Fehler ein komisches Verhalten zur Folge haben kann, wenn man z.B. <a href="http://de.wikipedia.org/wiki/Zone_%28DNS%29">Zone</a> im DNS überschreibt.</p>

<p>Die Installation auf dem <a href="http://www.raspberrypi.org/help/what-is-a-raspberry-pi/">Raspberry Pi</a> mit <a href="http://www.raspbian.org/">Raspbian</a> gestaltet sich realtiv einfach. Am besten macht macht
das ganze als <code>root</code></p>

<h3>Installation von MySQL</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo apt-get install mysql-server mysql-client php5-mysql
</code></pre></div>
<p>Danach habt Ihr MySQL installiert und auch den php Client, welchen wir später noch brauchen. Während
der Installation werdet ihr nach dem <code>root</code>-Passwort für den MySQL Server gefragt.</p>

<h3>Installation von PowerDNS</h3>

<p>Die Installation möchte Euch bei der Einrichtung der Datenbank behilflich sein. Aber wir konfigurieren
alles per Hand. Bei mir die automatische Konfiguration nicht so gut funktioniert.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo su
apt-get install pdns-server pdns-backend-mysql dnsutils
</code></pre></div>
<h3>Einrichten der Datenbank</h3>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">powerdns</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">ON</span> <span class="n">powerdns</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="n">powerdns</span><span class="o">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">&#39;GeheimesPasswort&#39;</span><span class="p">;</span>
<span class="n">FLUSH</span> <span class="k">PRIVILEGES</span><span class="p">;</span>
</code></pre></div>
<p>Das muss man in die <code>mysql</code> Konsole eintragen. Zu dieser gelangt man so:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">mysql -uroot -p
</code></pre></div>
<p>Nun importieren wir das Datenbank-Schema für PowerDNS</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">mysql -uroot -p powerdns &lt; /usr/share/doc/pdns-backend-mysql/nodnssec-3.x_to_3.4.0_schema.mysql.sql
</code></pre></div>
<h3>PowerDNS konfigurieren</h3>

<p>Die Datei <code>/etc/powerdns/pdns.d/pdns.local.gmysql.conf</code> muss wie folgt verändert werden:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># MySQL Configuration</span>
<span class="c">#</span>
<span class="c"># Launch gmysql backend</span>
launch+<span class="o">=</span>gmysql

<span class="c"># gmysql parameters</span>
gmysql-host<span class="o">=</span>127.0.0.1
gmysql-port<span class="o">=</span>3306
gmysql-dbname<span class="o">=</span>powerdns
gmysql-user<span class="o">=</span>powerdns
gmysql-password<span class="o">=</span>GeheimesPasswort
gmysql-dnssec<span class="o">=</span>yes
<span class="c"># gmysql-socket=</span>
</code></pre></div>
<p>Nun muss  man sie noch schützen <code>sudo chmod 660 /etc/powerdns/pdns.d/pdns.local.gmysql.conf</code>. Nun
wurder Der Server nur lokal funktionieren und nur seine eigenen Zonen auflösen können. Damit man
er auch noch über alle anderen Zonen Auskunft geben kann und jedes Gerät im LAN ihn nutzen kann
muss man ein paar Zeilen in der <code>/etc/powerdns/pdns.conf</code> ändern 
(sie sind schön auskommentiert enthälten, ohne Parameter). </p>
<div class="highlight"><pre><code class="language-text" data-lang="text">recursor=8.8.8.8

allow-recursion=127.0.0.1,192.168.0.0/24
</code></pre></div>
<p>Ich gehe davon aus, dass Euer LAN ein 192.168.0.0/24 Netz ist, sonst anpassen ;-).</p>

<h3>Test</h3>

<p>Wenn alles funktioniert, dann kann man den DNS Server wie folgt testen:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">dig google.de @8.8.8.8  

; &lt;&lt;&gt;&gt; DiG 9.9.5-3ubuntu0.2-Ubuntu &lt;&lt;&gt;&gt; google.de @127.0.0.1
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 49993
;; flags: qr rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
;; QUESTION SECTION:
;google.de.                     IN      A

;; ANSWER SECTION:
google.de.              299     IN      A       173.194.32.255
google.de.              299     IN      A       173.194.32.248
google.de.              299     IN      A       173.194.32.239
google.de.              299     IN      A       173.194.32.247

;; Query time: 87 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Wed Mar 18 07:12:42 CET 2015
;; MSG SIZE  rcvd: 102
</code></pre></div>
<h3>Poweradmin installieren</h3>

<p>Damit man den DNS Server einfach/schnell bedienen kann, installiert man <a href="http://www.poweradmin.org/">poweradmin</a>. Das ist
eine php-Anwendung mit der man seinen PowerDNS Server einfach konfigurieren kann.</p>

<p>Als erstes installiert man einen Webserver und php. Auf dem Raspberry Pi macht sich in meinen
Augen <a href="http://nginx.org/">Nginx</a> ganz gut. Wie man diesen installiert kann man in <a href="/raspberry%20pi/linux/2014/07/31/webserver-auf-dem-raspberry-pi-installieren/">diesem Artikel</a> nachlesen.</p>

<p>Um mit der eigenlichen Installation zu beginnen muss man nich php-mcrypt installieren.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">sudo apt-get install php5-mcrypt
</code></pre></div>
<p>Nun beginnt die Installtion</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">sudo su
cd /var/www
wget https://github.com/poweradmin/poweradmin/archive/v2.1.7.zip
unzip v2.1.7.zip
rm v2.1.7.zip
mv poweradmin-2.1.7 poweradmin
cat &lt;&lt; EOF &gt; /etc/nginx/sites-available/powerdns
server {
    listen 80;
    server_name &lt;IP des Raspberry Pi&gt;;

    root /var/www/poweradmin;
    index index.html index.php;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ ^(.+\.php)(.*)$ {
        try_files $fastcgi_script_name =404;
        fastcgi_split_path_info  ^(.+\.php)(.*)$;
        fastcgi_pass   unix:/var/run/php5-fpm.sock;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
        fastcgi_param  PATH_INFO        $fastcgi_path_info;
        include        /etc/nginx/fastcgi_params;
    }

    access_log      /var/log/nginx/poweradmin.access.log;
    error_log       /var/log/nginx/poweradmin.error.log;
}
EOF
ln -s /etc/nginx/sites-available/powerdns /etc/nginx/sites-enabled/powerdns
service nginx reload
</code></pre></div>
<p>Nun kann man seinen Server einfach konfigurieren. Dazu öffnet man http://<IP Raspberry Pi> im Browser
und konfiguriert erst einmal Poweradmin und dann kann man gleich loslegen mit dem anlegfen von neuen
Zonen. Das ganze ist recht selbsterklärend.</p>

    <hr>
    <div class="pagination btn-group">
      
        <a class="btn prev" href="/privat/2015/03/18/danke-primacom/" title="Danke Primacom">&larr; &Auml;lter</a>
      
        <a class="btn" href="/archive.html">Archiv</a>
      
        <a class="btn next" href="/linux/tools/2015/04/20/kaputtes-system-nach-restore-mit-obnam/" title="kaputtes System nach Restore mit Obnam">Neuer &rarr;</a>
      
    </div>
    





  </div>
  
  <div class="span4">
    <section>
      <h4>Ver&ouml;ffentlicht</h4>
      <div class="date"><span>18.03.2015</span></div>
    </section>
    <section>
      <h4>Letzte &Auml;nderung</h4>
      <div class="date"><span></span>18.03.2015 07:42 Uhr</div>
    </section>
    
      <section>
        <h4>Kategorie</h4>
        <span class="category">
          linux, raspberry pi
        </span>
      </section>
         
    
      <section>
        <h4>Tags</h4>
        <ul class="tag_box">
          
          


  
     
    	<li><a href="/tags.html#Raspbian-ref">Raspbian <span>5</span></a></li>
     
    	<li><a href="/tags.html#MySQL-ref">MySQL <span>3</span></a></li>
     
    	<li><a href="/tags.html#PowerDNS-ref">PowerDNS <span>1</span></a></li>
     
    	<li><a href="/tags.html#DNS-ref">DNS <span>1</span></a></li>
     
    	<li><a href="/tags.html#Linux-ref">Linux <span>9</span></a></li>
    
  



        </ul>
      </section>
             
  </div>
</div>


        </div>
        <hr>
      </div> <!-- /container -->

      <div class="footer-push"></div>
    </div><!--/.page-wrap -->

    <footer>
      <div class="container">
        <p>&copy; 2015 Michael Rennecke, some rights reserved</p>
        <p>Diese Seite ist unter der <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a> lizenziert.</p>
      </div>
    </footer>

    <script>window.jQuery || document.write('<script src="/assets/themes/hooligan/js/jquery.min.js"><\/script>')</script>
    <script type="text/javascript" src="/assets/themes/hooligan/bootstrap/js/bootstrap.min.js"></script>

    
  </body>
</html>

