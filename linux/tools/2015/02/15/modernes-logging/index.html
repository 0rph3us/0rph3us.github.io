
<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <title>
      
        Modernes Logging - 
      
      0rph3us
    </title>
    <meta name="description" content="">
    <meta name="author" content="Michael Rennecke">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="/assets/themes/hooligan/css/bar.css" rel="stylesheet" type="text/css" media="all" />
<!--    <link href="/assets/themes/hooligan/css/zocial.stripped.css" rel="stylesheet" type="text/css">
    <link href="/assets/themes/hooligan/css/syntax.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/darkstrap.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/lightbox.css" rel="stylesheet" type="text/css" media="all" />
-->
    
<!-- 
    <script type="text/javascript" src="/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="/js/lightbox.min.js"></script>
-->

    <!-- jquery-1.11.1.min.js and lightbox.min.js -->
    <script type="text/javascript" src="/js/a63bb257b0d48f7901f938d2f1217cbb.js" async></script>

    <!-- fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->
  </head>

  <body>
    <div id="page-wrap">
      <div class="navbar">
        <div class="navbar-inner">
          <div class="container">
            <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </a>

            <a class="brand" href="/">0rph3us</a>

            <div class="nav-collapse">
              <ul class="nav">
                
                
                


  
    
      
    
  
    
      
      	
      	<li><a href="/about.html">Über mich</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archiv</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Kategorien</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Seiten</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



              </ul>
              <ul class="nav pull-right social visible-desktop">
                <li class="divider-vertical"></li>
                
                <li>
                  <a href="https://github.com/0rph3us" class="zocial github icon" target="_blank">
                    <span class="hidden-desktop">Github</span>
                  </a>
                </li>
                
                
                
                <li>
                  <a href="https://twitter.com/0rph3us" class="zocial twitter icon" target="_blank">
                    <span class="hidden-desktop">Twitter</span>
                  </a>
                </li>
                
                
                
                
                
                <li>
                  <a href="https://0rph3us.github.io/rss.xml" class="zocial rss icon" target="_blank">
                    <span class="hidden-desktop">RSS Feed</span>
                  </a>
                </li>
                
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="content">
          
<div class="page-header">
  <h1>
    Modernes Logging 
    
  </h1>
</div>

<div class="row">
  <div class="span8">
    <p>Achtung: Es gibt einen <a href="/linux/tools/2015/02/24/modernes-logging-teil-2/">2. Teil des Artikels</a>, welchen sich vorher ansehen solle, bevor man hier alles copy&amp;pastet</p>

<p>In <a href="http://de.wikipedia.org/wiki/Java_%28Programmiersprache%29">Java</a>-Welt ist folgende Stack für Logging recht verbreitet, weil man mit ihm ein leistungsstarkes modernes und zentrales Logging umsetzten kann. Dieser Stack besteht aus <a href="http://www.elasticsearch.org/">Elasticsearch</a>, einen Volltextindex zum speichern der Nahrichten. Diese werden von <a href="http://logstash.net/">Logstash</a> verarbeitet und zum Index geschickt. <a href="http://www.elasticsearch.org/overview/kibana/">Kibana</a> wird zum
visualisieren der Volltextinhalte genommen. Ich finde Logstash zum reinen verschicken von Lognahrichten zu schwergewichtig und es bötigt zu viel Ressourcen. Linux verwendet <a href="http://de.wikipedia.org/wiki/Syslog">syslog</a> zum versenden von Lognachrichten. In vieles Distributionen wird <a href="http://www.rsyslog.com/">rsyslog</a> zum verarbeiten der Nahrichten verwendet. Das gute ist, dass man mit rsyslog auch direkt in Elasticsearch loggen kann. So kann man mit rsyslog, Elasticsearch und Kibana ein leichtgewichtigeres und modernes Logsystem bauen.</p>

<p>Die folgende Anleitung beschreibt, wie man das ganze unter Ubuntu 14.04 einrichtet. Ich beschreibe kein komplettes Setup, es ist als Einstieg in die Thematik gedacht.</p>

<h3>rsyslog unter Ubuntu 14.04 installieren</h3>

<p>Eine Konsole öffnen und das Repository hinzufügen. Es handelt sich hierbei um das <a href="http://www.rsyslog.com/ubuntu-repository/">offizelle Repository</a> von rsyslog. Rsyslog ist in den offizellen Repositories von Ubuntu nicht auf dem neusten Stand, außerdem gibt kein Paket mit dem Elasticsearchsupport.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">sudo add-apt-repository ppa:adiscon/v8-stable
</code></pre></div>
<p>Den Cache von <code>apt</code> aktualisieren und <code>rsyslog</code> mit der Elasticsearch Unterstützung installieren</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">sudo apt-get update
sudo apt-get install rsyslog rsyslog-elasticsearch
</code></pre></div>
<h3>Elasticsearch installieren</h3>

<p>deb-Paket herunterladen und installieren. Die Installation über das deb-Paket hat den Vorteil, dass man Elasticsearch einfach updaten kann und es gibt auch schon init-Skripte.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">wget https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-1.4.3.deb
sudo dpkg -i elasticsearch-1.4.3.deb
sudo update-rc.d elasticsearch defaults
</code></pre></div>
<p>Elasticsearch konfigurieren. Dazu muss man die Datei <code>/etc/elasticsearch/elasticsearch.yml</code> im Editor seine Wahl öffnen und die folgenden Zeilen einkommentieren und ändern</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># Set the number of shards (splits) of an index (5 by default):</span>
<span class="c1">#</span>
<span class="l-Scalar-Plain">index.number_of_shards</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>

<span class="c1"># Set the number of replicas (additional copies) of an index (1 by default):</span>
<span class="c1">#</span>
<span class="l-Scalar-Plain">index.number_of_replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</code></pre></div>
<p>Elasticsearch starten:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">sudo service elasticsearch start
</code></pre></div>
<h3>rsyslog konfigurieren</h3>

<p>Man muss nun dafür sorgen, dass die Lognahrichten von rsyslog nach Elasticsearch geschrieben werden. Als erstes legt man ein <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping.html">Mapping</a> in Elasticsearch an. Damit sagt man Elasticsearch, dass es das Feld <code>program</code> <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping-core-types.html">nicht analysieren</a> soll. Außerdem sollen die Dokumente nach <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping-ttl-field.html">90 Tagen gelöscht</a> werden.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">curl -XPUT <span class="s1">&#39;http://localhost:9200/logstash&#39;</span> -d <span class="s1">&#39;{</span>
<span class="s1">  &quot;mappings&quot;: {</span>
<span class="s1">    &quot;events&quot; : {</span>
<span class="s1">      &quot;_ttl&quot; : {</span>
<span class="s1">        &quot;enabled&quot; : true,</span>
<span class="s1">        &quot;default&quot; : &quot;90d&quot;</span>
<span class="s1">        },</span>
<span class="s1">      &quot;properties&quot; : {</span>
<span class="s1">        &quot;program&quot; : {</span>
<span class="s1">          &quot;type&quot; : &quot;string&quot;,</span>
<span class="s1">          &quot;index&quot; : &quot;not_analyzed&quot;,</span>
<span class="s1">          &quot;norms&quot; : {</span>
<span class="s1">            &quot;enabled&quot; : false</span>
<span class="s1">          }</span>
<span class="s1">        }</span>
<span class="s1">      }</span>
<span class="s1">    }</span>
<span class="s1">  }</span>
<span class="s1">}&#39;</span>
</code></pre></div>
<p>Nach man die Datei  <code>/etc/rsyslog.d/30-elasticsearch.conf</code> erstellt hat, muss
man nur noch <code>rsyslog</code> neu starten. Wenn es Probleme gibt kann man mit <code>rsyslogd -N1</code> die Konfiguraion überprüfen.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">sudo su -
cat <span class="s">&lt;&lt; EOF &gt; /etc/rsyslog.d/30-elasticsearch.conf</span>
<span class="s">#module(load=&quot;imuxsock&quot;)       # for listening to /dev/log, normal not needed</span>
<span class="s">module(load=&quot;omelasticsearch&quot;) # for outputting to Elasticsearch</span>

<span class="s"># this is for index names to be like: logstash-YYYY.MM.DD</span>
<span class="s">template(name=&quot;logstash-index&quot;</span>
<span class="s">  type=&quot;list&quot;) {</span>
<span class="s">    constant(value=&quot;logstash-&quot;)</span>
<span class="s">    property(name=&quot;timereported&quot; dateFormat=&quot;rfc3339&quot; position.from=&quot;1&quot; position.to=&quot;4&quot;)</span>
<span class="s">    constant(value=&quot;.&quot;)</span>
<span class="s">    property(name=&quot;timereported&quot; dateFormat=&quot;rfc3339&quot; position.from=&quot;6&quot; position.to=&quot;7&quot;)</span>
<span class="s">    constant(value=&quot;.&quot;)</span>
<span class="s">    property(name=&quot;timereported&quot; dateFormat=&quot;rfc3339&quot; position.from=&quot;9&quot; position.to=&quot;10&quot;)</span>
<span class="s">}</span>

<span class="s"># use only one index, useful only for local usage</span>
<span class="s">template(name=&quot;logstash&quot; type=&quot;string&quot; string=&quot;logstash&quot;)</span>

<span class="s"># this is for formatting our syslog in JSON with @timestamp</span>
<span class="s">template(name=&quot;plain-syslog&quot;</span>
<span class="s">  type=&quot;list&quot;) {</span>
<span class="s">    constant(value=&quot;{&quot;)</span>
<span class="s">      constant(value=&quot;\&quot;@timestamp\&quot;:\&quot;&quot;)     property(name=&quot;timereported&quot; dateFormat=&quot;rfc3339&quot;)</span>
<span class="s">      constant(value=&quot;\&quot;,\&quot;host\&quot;:\&quot;&quot;)        property(name=&quot;hostname&quot;)</span>
<span class="s">      constant(value=&quot;\&quot;,\&quot;severity\&quot;:\&quot;&quot;)    property(name=&quot;syslogseverity-text&quot;)</span>
<span class="s">      constant(value=&quot;\&quot;,\&quot;facility\&quot;:\&quot;&quot;)    property(name=&quot;syslogfacility-text&quot;)</span>
<span class="s">      constant(value=&quot;\&quot;,\&quot;tag\&quot;:\&quot;&quot;)         property(name=&quot;syslogtag&quot; format=&quot;json&quot;)</span>
<span class="s">      constant(value=&quot;\&quot;,\&quot;program\&quot;:\&quot;&quot;)     property(name=&quot;programname&quot;)</span>
<span class="s">      constant(value=&quot;\&quot;,\&quot;message\&quot;:\&quot;&quot;)     property(name=&quot;msg&quot; format=&quot;json&quot;)</span>
<span class="s">    constant(value=&quot;\&quot;}&quot;)</span>
<span class="s">}</span>

<span class="s"># this is where we actually send the logs to Elasticsearch (localhost:9200 by default)</span>
<span class="s">action(type=&quot;omelasticsearch&quot;</span>
<span class="s">    template=&quot;plain-syslog&quot;</span>
<span class="s">    searchIndex=&quot;logstash&quot;</span>
<span class="s">    dynSearchIndex=&quot;on&quot;)</span>

<span class="s">EOF</span>
/etc/init.d/rsyslog restart
<span class="nb">exit</span>
</code></pre></div>
<h3>Kibana installieren</h3>

<p>Für Kibana gibt es leider keinen bequemen Installationsweg. Deswegen beschreibe ich den Weg, der schnell und einfach zum Ziel führt, aber auf keinen Fall sinnvoll für den produktiven Betrieb ist. Man läd Kibana herunter und startet es.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">wget https://download.elasticsearch.org/kibana/kibana/kibana-4.0.0-rc1-linux-x64.tar.gz
tar xfvz kibana-4.0.0-rc1-linux-x64.tar.gz
kibana-4.0.0-rc1-linux-x64/bin/kibana
</code></pre></div>
<p>Nun kann man auf Kibana über <code>http://127.0.0.1:5601/</code> im Browser zugreifen. Man muss nur noch Kibana sagen, welchen Index es benutzen soll. Das geht realtiv intuitiv.</p>

<h3>Anmerkung</h3>

<p>Das es rsyslog auch für Windows gibt, kann man diesen Stack auch für Windows nutzen. Ich habe hier alle Technologien nur angeschitten, für ein richtiges Setup muss man noch viel mehr beachten und konfigurieren.</p>

    <hr>
    <div class="pagination btn-group">
      
        <a class="btn prev" href="/linux/tools/2015/02/12/skripte-parallelisieren/" title="Skripte parallelisieren">&larr; &Auml;lter</a>
      
        <a class="btn" href="/archive.html">Archiv</a>
      
        <a class="btn next" href="/linux/2015/02/19/pakete-selbst-bauen/" title="Pakete selbst bauen">Neuer &rarr;</a>
      
    </div>
    





  </div>
  
  <div class="span4">
    <section>
      <h4>Ver&ouml;ffentlicht</h4>
      <div class="date"><span>15.02.2015</span></div>
    </section>
    <section>
      <h4>Letzte &Auml;nderung</h4>
      <div class="date"><span></span>26.02.2015 18:17 Uhr</div>
    </section>
    
      <section>
        <h4>Kategorie</h4>
        <span class="category">
          linux, tools
        </span>
      </section>
         
    
      <section>
        <h4>Tags</h4>
        <ul class="tag_box">
          
          


  
     
    	<li><a href="/tags.html#logstash-ref">logstash <span>1</span></a></li>
     
    	<li><a href="/tags.html#rsyslog-ref">rsyslog <span>1</span></a></li>
     
    	<li><a href="/tags.html#syslog-ref">syslog <span>1</span></a></li>
     
    	<li><a href="/tags.html#kibana-ref">kibana <span>2</span></a></li>
     
    	<li><a href="/tags.html#elasticsearch-ref">elasticsearch <span>2</span></a></li>
     
    	<li><a href="/tags.html#logging-ref">logging <span>1</span></a></li>
    
  



        </ul>
      </section>
             
  </div>
</div>


        </div>
        <hr>
      </div> <!-- /container -->

      <div class="footer-push"></div>
    </div><!--/.page-wrap -->

    <footer>
      <div class="container">
        <p>&copy; 2015 Michael Rennecke, some rights reserved</p>
        <p>Diese Seite ist unter der <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a> lizenziert.</p>
      </div>
    </footer>

    <script>window.jQuery || document.write('<script src="/assets/themes/hooligan/js/jquery.min.js"><\/script>')</script>
    <script type="text/javascript" src="/assets/themes/hooligan/bootstrap/js/bootstrap.min.js"></script>

    
  </body>
</html>

