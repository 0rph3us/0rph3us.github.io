
<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <title>
      
        verschlüsselte Volumes bequem mounten - 
      
      0rph3us
    </title>
    
    <meta name="author" content="Michael Rennecke">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="/assets/themes/hooligan/css/bar.css" rel="stylesheet" type="text/css" media="all" />
<!--    <link href="/assets/themes/hooligan/css/zocial.stripped.css" rel="stylesheet" type="text/css">
    <link href="/assets/themes/hooligan/css/syntax.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/darkstrap.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/lightbox.css" rel="stylesheet" type="text/css" media="all" />
-->
    
<!-- 
    <script type="text/javascript" src="/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="/js/lightbox.min.js"></script>
-->

    <!-- jquery-1.11.1.min.js and lightbox.min.js -->
    <script type="text/javascript" src="/js/a63bb257b0d48f7901f938d2f1217cbb.js" async></script>

    <!-- fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->
  </head>

  <body>
    <div id="page-wrap">
      <div class="navbar">
        <div class="navbar-inner">
          <div class="container">
            <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </a>

            <a class="brand" href="/">0rph3us</a>

            <div class="nav-collapse">
              <ul class="nav">
                
                
                


  
    
      
    
  
    
      
      	
      	<li><a href="/about.html">Über mich</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archiv</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Kategorien</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Seiten</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



              </ul>
              <ul class="nav pull-right social visible-desktop">
                <li class="divider-vertical"></li>
                
                <li>
                  <a href="https://github.com/0rph3us" class="zocial github icon" target="_blank">
                    <span class="hidden-desktop">Github</span>
                  </a>
                </li>
                
                
                
                <li>
                  <a href="https://twitter.com/0rph3us" class="zocial twitter icon" target="_blank">
                    <span class="hidden-desktop">Twitter</span>
                  </a>
                </li>
                
                
                
                
                
                <li>
                  <a href="https://0rph3us.github.io/rss.xml" class="zocial rss icon" target="_blank">
                    <span class="hidden-desktop">RSS Feed</span>
                  </a>
                </li>
                
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="content">
          
<div class="page-header">
  <h1>
    verschlüsselte Volumes bequem mounten 
    
  </h1>
</div>

<div class="row">
  <div class="span8">
    <p>
Ich habe mein home verschlüsselt. Dieses wird automatisch, beim anmelden gemountet. Da ich in mein home noch ein paar andere verschlüsselte Dateisysteme einhänge funktionieren die Standard-Mittel, wie <tt>/etc/crypttab</tt> nicht. Dabei ergibt sich das folgende Problem: Die Volumes werden beim booten eingehangen und zu diesen Zeitpunkt existiert mein home noch nicht.</p>
<p> Da ich <em>faul</em> bin möchte ich auch möglichst wenig Passwörter eingeben, weiterhin soll meine Freundin auch den Rechner anmachen können und nicht an meinen Passwort scheitern. Deswegen wird nur mein home via Passwort entschlüsselt, für die anderen Dateisysteme kommen <em>key-files</em> zum Einsatz. Diese liegen in meinen <strong>verschlüsselten</strong> home.</p>
<p>
Da ich mir selbst nicht vertraue, möchte ich den <a href="http://linux.die.net/man/8/sudo">sudo</a>-Mechanismus oder <a href="http://linux.die.net/man/2/setuid">suid</a>-Bits nicht benutzten. Deswegen habe ich mir die beiden Skripte <tt>cryptdisks_start</tt> und <tt>cryptdisks_stop</tt> genauer angesehen. In einen ersten Schritt habe ich mir eine <tt>/etc/user_crypttab</tt> erzeugt.</p>
<pre lang="bash">
root@walhalla ~ # cat /etc/user_crypttab
# definition             volume                        key                                   options      mountpoint                mountoptions
data--group-video_crypt  /dev/mapper/data--group-video /home/rennecke/key-files/video-key    luks         /home/rennecke/Videos     noatime
</pre>
<p>
Die ersten vier Parameter entsprechen denen, der <tt><a href="http://linux.die.net/man/5/crypttab">crypttab</a></tt>, <em>mountpoint</em> und <em>mountoptions</em> sind entsprechen den gleichnamigen Optionen von <tt><a href="http://linux.die.net/man/8/mount">mount</a></tt>.</p>
<p>Mein <tt>user_cryptdisks_start</tt>-Skript sieht wie folgt aus:</p>
<pre lang="bash">
#!/bin/sh

# user_cryptdisks_start - wrapper around cryptsetup which parses
# /etc/user_crypttab, just like mount parses /etc/fstab.

# Initial code stolen from cryptdisks_start by Jon Dowland <jon@alcopop.org>
# Copyright (C) 2011 by Michael Rennecke <michael_rennecke@gmx.net>
# License: GNU General Public License, v2 or any later
# (http://www.gnu.org/copyleft/gpl.html)

CRYPTTAB="/etc/user_crypttab"

set -e

if [ $# -lt 1 ]; then
	echo "usage: $0 <name>" >&2
	echo >&2
	echo "reads $CRYPTTAB and starts the mapping corresponding to <name>" >&2
	exit 1
fi

. /lib/cryptsetup/cryptdisks.functions

INITSTATE="manual"
DEFAULT_LOUD="yes"

if [ -x "/usr/bin/id" ] && [ "$(/usr/bin/id -u)"  != "0" ]; then
	log_warning_msg "$0 needs root privileges"
	exit 1
fi

log_action_begin_msg "Starting crypto disk"
mount_fs


count=0
tablen="$(egrep -vc "^[[:space:]]*(#|$)" "$CRYPTTAB")"
egrep -v "^[[:space:]]*(#|$)" "$CRYPTTAB" | while read dst src key opts mnt mopts; do
	count=$(( $count + 1 ))
	echo ""
	if [ "$1" = "$dst" ]; then
		ret=0
		handle_crypttab_line_start "$dst" "$src" "$key" "$opts" <&3 || ret=$?
		echo ""
		fsck -pv /dev/mapper/$dst
		echo ""
		mount -o $mopts /dev/mapper/$dst $mnt
	elif [ $count -ge $tablen ]; then
		ret=1
		device_msg "$1" "failed, not found in user_crypttab"
	else
		continue
	fi
	umount_fs
	log_action_end_msg $ret
	exit $ret
done 3<&1
</name></name></pre>
<p>Zum Schluss noch mein  <tt>user_cryptdisks_stop</tt>-Skript:</p>
<pre lang="bash">
#!/bin/sh

# user_cryptdisks_stop - wrapper around cryptsetup which parses
# /etc/user_crypttab, just like mount parses /etc/fstab.

# Initial code stolen from cryptdisks_stop by Jonas Meurer <jonas@freesources.org>
# Copyright (C) 2011 by Michael Rennecke <michael_rennecke@gmx.net>
# License: GNU General Public License, v2 or any later
# (http://www.gnu.org/copyleft/gpl.html)

CRYPTTAB=/etc/user_crypttab

set -e

if [ $# -lt 1 ]; then
	echo "usage: $0 <name>" >&2
	echo >&2
	echo "reads $CRYPTTAB and stops the mapping corresponding to <name>" >&2
	exit 1
fi

. /lib/cryptsetup/cryptdisks.functions

INITSTATE="manual"
DEFAULT_LOUD="yes"

if [ -x "/usr/bin/id" ] && [ "$(/usr/bin/id -u)"  != "0" ]; then
	log_warning_msg "$0 needs root privileges"
	exit 1
fi

log_action_begin_msg "Stopping crypto disk"
echo ""

count=0
tablen="$(egrep -vc "^[[:space:]]*(#|$)" "$CRYPTTAB")"
egrep -v "^[[:space:]]*(#|$)" "$CRYPTTAB" | while read dst src key opts mnt mopts; do
	count=$(( $count + 1 ))
	if [ "$1" = "$dst" ]; then
		umount $mnt

		ret=0
		handle_crypttab_line_stop "$dst" "$src" "$key" "$opts" <&3 || ret=$?
	elif [ $count -ge $tablen ]; then
		ret=1
		device_msg "$1" "failed, not found in user_crypttab"
	else
		continue
	fi
	log_action_end_msg $ret
	exit $ret
done 3<&
</name></name></pre>
<p>
Die beiden Skripte kann nun <tt>root</tt> ausführen, um Dateisysteme einzuhängen. Bei jeden einhängen wird geschaut, ob ein <tt><a href="http://linux.die.net/man/8/fsck">fsck</a></tt> nötig ist. Mein Dank gilt <a href="http://blog.meet-unix.org/">meet-unix</a>, er hat stand mit mit Rat zu Seite, da ich noch etwas <em>Solaris</em>-geschädigt bin. Anmerkungen, bitte als Kommentar hinterlassen.</p>

    <hr>
    <div class="pagination btn-group">
      
        <a class="btn prev" href="/linux/2011/03/25/verschlusseltes-home-automatisch-mounten/" title="verschlüsseltes home automatisch mounten">&larr; &Auml;lter</a>
      
        <a class="btn" href="/archive.html">Archiv</a>
      
        <a class="btn next" href="/linux/tools/2011/05/18/nosql-datenbanken/" title="noSQL Datenbanken">Neuer &rarr;</a>
      
    </div>
    





  </div>
  
  <div class="span4">
    <section>
      <h4>Ver&ouml;ffentlicht</h4>
      <div class="date"><span>26.03.2011</span></div>
    </section>
    <section>
      <h4>Letzte &Auml;nderung</h4>
      <div class="date"><span></span>19.05.2015 12:47 Uhr</div>
    </section>
         
    
      <section>
        <h4>Tags</h4>
        <ul class="tag_box">
          
          


  
     
    	<li><a href="/tags.html#Security-ref">Security <span>7</span></a></li>
     
    	<li><a href="/tags.html#dm-crypt-ref">dm-crypt <span>2</span></a></li>
     
    	<li><a href="/tags.html#Debian-ref">Debian <span>7</span></a></li>
     
    	<li><a href="/tags.html#crypttab-ref">crypttab <span>1</span></a></li>
     
    	<li><a href="/tags.html#crypt-ref">crypt <span>2</span></a></li>
    
  



        </ul>
      </section>
             
  </div>
</div>


        </div>
        <hr>
      </div> <!-- /container -->

      <div class="footer-push"></div>
    </div><!--/.page-wrap -->

    <footer>
      <div class="container">
        <p>&copy; 2015 Michael Rennecke, some rights reserved</p>
        <p>Diese Seite ist unter der <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a> lizenziert.</p>
      </div>
    </footer>

    <script>window.jQuery || document.write('<script src="/assets/themes/hooligan/js/jquery.min.js"><\/script>')</script>
    <script type="text/javascript" src="/assets/themes/hooligan/bootstrap/js/bootstrap.min.js"></script>

    
  </body>
</html>

